## Glow Impact Score — Math Audit

- **Wallet**: `0x5e230fed487c86b90f6508104149f087d9b1b0a7`
- **Week range**: **97 → 107** (inclusive)
- **Generated by**: `scripts/impact-score.ts` (same logic as `computeGlowImpactScores()`)

---

## 1) Constants & units

- **GLW base units**: wei (18 decimals)
- **Points internal precision**: scaled by **1e6** (6 decimals)

Points coefficients (per spec):

- **Inflation**: +1 point / GLW
  - `INFLATION_POINTS_PER_GLW_SCALED6 = 1_000_000`
- **Steering**: +3 points / GLW
  - `STEERING_POINTS_PER_GLW_SCALED6 = 3_000_000`
- **Vault bonus**: +0.005 points / GLW / week
  - `VAULT_BONUS_POINTS_PER_GLW_SCALED6 = 5_000`
- **GlowWorth (continuous)**: +0.001 points / GLW / week
  - `GLOW_WORTH_POINTS_PER_GLW_SCALED6 = 1_000`

Core conversion:

\[
\text{pointsScaled6} = \left\lfloor \frac{\text{glwWei} \times \text{pointsPerGlwScaled6}}{10^{18}} \right\rfloor
\]

Returned values are `formatUnits(pointsScaled6, 6)`.

---

## 2) Data sources (raw inputs)

### 2.1 Liquid GLW (onchain)

- **Source**: `viem` public client on mainnet
- **Contract**: GLW ERC20 `balanceOf(wallet)`
- **Value used (wei)**: `398710273328199502473`
  - **Liquid GLW**: `398.710273328199502473`

### 2.2 Inflation rewards + protocol-deposit rewards (weekly)

- **Source**: Control API farm rewards history (batch) for the requested range
- **Endpoint shape used**: `POST /farms/by-wallet/farm-rewards-history/batch`
- **Fields used** per farm/week row:
  - `walletTotalGlowInflationReward` (wei)
  - `walletProtocolDepositFromLaunchpad` (native decimals; for this wallet `asset=GLW` so it is wei)

For unclaimed rewards we use Control API pre-aggregated weekly wallet rewards:

- **Endpoint**: `GET /wallets/address/:wallet/weekly-rewards?paymentCurrency=GLW&limit=520`
- **Fields used** per week:
  - `glowInflationTotal` (wei)
  - `protocolDepositRewardsReceived` (wei, because `paymentCurrency=GLW`)

### 2.3 Delegation / refunds (launchpad purchases)

- **Source**: local DB (`fraction_splits`, `fraction_refunds`) for the requested time window.
- **Mapping**: each split/refund is assigned to a protocol week via its timestamp.
- **Deltas**:
  - Launchpad purchase: `+amount`
  - Launchpad refund: `-amount`

### 2.4 Steering inputs (staked GCTL + region rewards)

- Wallet stake snapshot:

  - **Endpoint**: `GET https://api-prod-34ce.up.railway.app/wallets/address/:wallet`
  - Relevant fields:
    - `regions[]: { regionId, totalStaked }`

- Global region reward distribution:
  - **Endpoint**: `GET https://api-prod-34ce.up.railway.app/rewards/glw/regions`
  - Relevant fields:
    - `regionRewards[]: { regionId, gctlStaked, glwReward }`

**Important**: steering is currently computed from the **current stake snapshot** and applied uniformly across the queried week range.

### 2.5 Claims (on-chain claimed rewards)

- **Endpoint**: `GET https://glow-ponder-listener-2-production.up.railway.app/rewards/claims/:address?limit=5000`
- For unclaimed GLW, we sum claims where:
  - `token == GLW token address` (`0xf4fbc617a5733eaaf9af08e1ab816b103388d8b6`)

---

## 3) Derived quantities

## 3.1 Unclaimed GLW rewards

We compute:

\[
\text{Unclaimed} = \max(0, \text{ClaimableFromControlApi} - \text{ClaimedOnChain})
\]

### ClaimableFromControlApi

- From `weekly-rewards?paymentCurrency=GLW`
- Let `maxWeek = max(rewards[].weekNumber)`
- **Lag window**: `UNCLAIMED_LAG_WEEKS = 3`
- `claimableEndWeek = maxWeek - 3`
- Sum `glowInflationTotal + protocolDepositRewardsReceived` for weeks `<= claimableEndWeek`

Computed values:

- `maxWeek = 107`
- `claimableEndWeek = 104`
- **Claimable (wei)**: `213515936838233278465`
- **Claimable (GLW)**: `213.515936838233278465`

### ClaimedOnChain

Sum of GLW claim rows from claims API:

- **Claimed (wei)**: `169685122553876784083`
- **Claimed (GLW)**: `169.685122553876784083`

### Unclaimed

- **Unclaimed (wei)**: `43830814284356494382`
- **Unclaimed (GLW)**: `43.830814284356494382`

## 3.2 Steering GLW (per week)

For each region `i` where the wallet has stake:

\[
\text{walletSteeredGlwWei}\_i = \left\lfloor \frac{\text{regionGlwRewardWei}\_i \times \text{walletGctlStaked}\_i}{\text{regionTotalGctlStaked}\_i} \right\rfloor
\]

Then:

\[
\text{steeringGlwWeiPerWeek} = \sum_i \text{walletSteeredGlwWei}\_i
\]

Wallet is staked equally in 2 regions (3 and 4):

- Region 3 contribution (wei): `866058103220686167` (GLW: `0.866058103220686167`)
- Region 4 contribution (wei): `866058103220686167` (GLW: `0.866058103220686167`)

So:

- **Steering GLW per week (wei)**: `1732116206441372334`
- **Steering GLW per week (GLW)**: `1.732116206441372334`

Steering points per week:

\[
\text{steeringPointsScaled6} = \left\lfloor \frac{\text{steeringGlwWeiPerWeek} \times 3{,}000{,}000}{10^{18}} \right\rfloor
\]

- Steering points per week: `5.196348`

Total steering points across 11 weeks:

- `5.196348 × 11 = 57.159828`

## 3.3 DelegatedActiveGLW (per week)

Within the requested week range, we track:

- `delegatedCumulative`: sum of launchpad purchases − refunds up to that week
- `recoveredCumulative`: sum of protocol deposit rewards received up to that week

Then:

\[
\text{DelegatedActiveGLW} = \max(0, \text{delegatedCumulative} - \text{recoveredCumulative})
\]

In this wallet’s case, protocol deposit rewards are paid in GLW (`asset=GLW`), so conversion is identity.

## 3.4 GlowWorth (per week)

\[
\text{GlowWorthWeek} = \text{LiquidGLW} + \text{DelegatedActiveGLW(week)} + \text{UnclaimedGLWRewards}
\]

We treat `LiquidGLW` and `UnclaimedGLWRewards` as constant across the requested range.

---

## 4) Week-by-week calculations

Below is the computed weekly table (GLW columns are human-readable conversions of wei; points are the exact strings returned by the implementation).

| week | inflation_glw | steering_glw | pd_recovered_glw | delegated_active_glw | glow_worth_glw | inflation_pts | steering_pts | vault_pts | rollover_pre |  rollover | continuous |     total | cash_3x |
| ---: | ------------: | -----------: | ---------------: | -------------------: | -------------: | ------------: | -----------: | --------: | -----------: | --------: | ---------: | --------: | :-----: |
|   97 |      0.000000 |     1.732116 |         0.000000 |             0.000000 |     442.541088 |             0 |     5.196348 |         0 |     5.196348 |  5.196348 |   0.442541 |  5.638889 |   no    |
|   98 |     74.678925 |     1.732116 |         2.485907 |           246.098550 |     688.639638 |     74.678924 |     5.196348 |  1.230492 |    81.105764 | 81.105764 |   0.688639 | 81.794403 |   no    |
|   99 |     36.247460 |     1.732116 |         3.238053 |           242.860498 |     685.401585 |      36.24746 |     5.196348 |  1.214302 |     42.65811 |  42.65811 |   0.685401 | 43.343511 |   no    |
|  100 |     28.039502 |     1.732116 |         3.377500 |           239.482997 |     682.024085 |     28.039502 |     5.196348 |  1.197414 |    34.433264 | 34.433264 |   0.682024 | 35.115288 |   no    |
|  101 |     17.913165 |     1.732116 |         3.704611 |           235.778386 |     678.319474 |     17.913164 |     5.196348 |  1.178891 |    24.288403 | 24.288403 |   0.678319 | 24.966722 |   no    |
|  102 |     12.960244 |     1.732116 |         3.206083 |           232.572303 |     675.113391 |     12.960243 |     5.196348 |  1.162861 |    19.319452 | 19.319452 |   0.675113 | 19.994565 |   no    |
|  103 |     11.785845 |     1.732116 |         3.304994 |           229.267309 |     671.808397 |     11.785844 |     5.196348 |  1.146336 |    18.128528 | 18.128528 |   0.671808 | 18.800336 |   no    |
|  104 |      9.175286 |     1.732116 |         3.398363 |           225.868947 |     668.410034 |      9.175286 |     5.196348 |  1.129344 |    15.500978 | 15.500978 |    0.66841 | 16.169388 |   no    |
|  105 |      9.057188 |     1.732116 |         3.398363 |           222.470584 |     665.011672 |      9.057187 |     5.196348 |  1.112352 |    15.365887 | 15.365887 |   0.665011 | 16.030898 |   no    |
|  106 |      9.057188 |     1.732116 |         3.398363 |           219.072222 |     661.613309 |      9.057187 |     5.196348 |  1.095361 |    15.348896 | 15.348896 |   0.661613 | 16.010509 |   no    |
|  107 |      9.057188 |     1.732116 |         3.398363 |           215.673859 |     658.214947 |      9.057187 |     5.196348 |  1.078369 |    15.331904 | 15.331904 |   0.658214 | 15.990118 |   no    |

---

## 5) Totals (range 97–107)

From the computed result:

- **Total points**: `293.854627`
  - **Rollover points**: `286.677534`
    - Inflation points: `217.971984`
    - Steering points: `57.159828`
    - Vault bonus points: `11.545722`
  - **Continuous points**: `7.177093`

Sanity checks:

- Total steering GLW across range (wei): `19053278270855095674`
  - equals `1732116206441372334 × 11`

---

## 6) Full computed JSON (canonical output)

This is the full `computeGlowImpactScores()` output for the wallet (startWeek=97, endWeek=107):

```json
{
  "walletAddress": "0x5e230fed487c86b90f6508104149f087d9b1b0a7",
  "weekRange": {
    "startWeek": 97,
    "endWeek": 107
  },
  "glowWorth": {
    "walletAddress": "0x5e230fed487c86b90f6508104149f087d9b1b0a7",
    "liquidGlwWei": "398710273328199502473",
    "delegatedActiveGlwWei": "215673858979220481299",
    "unclaimedGlwRewardsWei": "43830814284356494382",
    "glowWorthWei": "658214946591776478154",
    "dataSources": {
      "liquidGlw": "onchain",
      "delegatedActiveGlw": "db+control-api",
      "unclaimedGlwRewards": "claims-api+control-api"
    }
  },
  "totals": {
    "totalPoints": "293.854627",
    "rolloverPoints": "286.677534",
    "continuousPoints": "7.177093",
    "inflationPoints": "217.971984",
    "steeringPoints": "57.159828",
    "vaultBonusPoints": "11.545722",
    "totalInflationGlwWei": "217971989190297342491",
    "totalSteeringGlwWei": "19053278270855095674"
  }
}
```
