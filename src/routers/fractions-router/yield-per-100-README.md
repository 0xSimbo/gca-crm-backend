# GET `/fractions/yield-per-100`

Returns GLW yield metrics per week for delegators and miners, showing how much GLW is earned per 100 GLW delegated and per $100 USD spent on mining equipment.

## Endpoint

```
GET /fractions/yield-per-100
```

## Query Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `debug` | string | No | Include detailed breakdown and intermediate totals. Use `"true"` or `"1"` |

## Response

### Basic Response (without debug)

```json
{
  "weekRange": {
    "startWeek": 97,
    "endWeek": 102
  },
  "metrics": {
    "glwPerWeekPer100UsdMiner": "13833902856164613616",
    "glwPerWeekPer100GlwDelegated": "5021799038871272148"
  }
}
```

### Debug Response (with `?debug=true`)

```json
{
  "weekRange": {
    "startWeek": 97,
    "endWeek": 102
  },
  "metrics": {
    "glwPerWeekPer100UsdMiner": "13833902856164613616",
    "glwPerWeekPer100GlwDelegated": "5021799038871272148"
  },
  "totals": {
    "totalGlwDelegated": "1062262722674884260496713",
    "totalUsdcSpentByMiners": "49737000000",
    "totalGlwEarnedByDelegatorsLastWeek": "53344699197575144906535",
    "totalGlwEarnedByMinersLastWeek": "6880568263570593874277",
    "farmsWithLaunchpad": 10,
    "farmsWithMiningCenter": 5
  },
  "delegatorFarms": [
    {
      "farmId": "0947b6e5-21dd-470a-b640-d7d319dd77b6",
      "farmName": "Solar Farm Alpha",
      "sponsorSplitPercent": 65,
      "totalFarmInflation": "8476287454116632669880",
      "totalFarmProtocolDeposit": "1362551175471803403609",
      "delegatorInflationShare": "5509586845175811235422",
      "sponsorInflationShare": "2966700608940821434458",
      "delegatorProtocolDepositShare": "1362551175471803403609",
      "totalDelegatorRewards": "6872138020647614639031"
    }
  ],
  "minerFarms": [
    {
      "farmId": "0947b6e5-21dd-470a-b640-d7d319dd77b6",
      "farmName": "Solar Farm Alpha",
      "sponsorSplitPercent": 6,
      "totalSteps": 3,
      "soldSteps": 3,
      "isPartiallyFilled": false,
      "totalFarmInflation": "8476287454116632669880",
      "totalFarmProtocolDeposit": "1362551175471803403609",
      "minerInflationShare": "508577247246997960192",
      "minerProtocolDepositShare": "0",
      "totalMinerRewards": "508577247246997960192"
    }
  ]
}
```

## Response Fields

### Metrics

| Field | Type | Description |
|-------|------|-------------|
| `glwPerWeekPer100GlwDelegated` | string | GLW earned per week per 100 GLW delegated (18 decimals, wei format) |
| `glwPerWeekPer100UsdMiner` | string | GLW earned per week per $100 USD spent on mining equipment (18 decimals, wei format) |

### Week Range

| Field | Type | Description |
|-------|------|-------------|
| `startWeek` | number | First week included in calculation (week 97 - first delegation week) |
| `endWeek` | number | Last completed week included in calculation |

### Totals (debug only)

| Field | Type | Description |
|-------|------|-------------|
| `totalGlwDelegated` | string | Total GLW delegated across all filled launchpad fractions (18 decimals, wei) |
| `totalUsdcSpentByMiners` | string | Total USDC spent on mining-center fractions (6 decimals) |
| `totalGlwEarnedByDelegatorsLastWeek` | string | Total GLW earned by all delegators in the last week (18 decimals, wei) |
| `totalGlwEarnedByMinersLastWeek` | string | Total GLW earned by all miners in the last week (18 decimals, wei) |
| `farmsWithLaunchpad` | number | Count of farms with launchpad fractions |
| `farmsWithMiningCenter` | number | Count of farms with mining-center fractions |

### Delegator Farms Breakdown (debug only)

Each delegator farm entry includes:

| Field | Type | Description |
|-------|------|-------------|
| `farmId` | string | Farm UUID |
| `farmName` | string \| null | Farm name |
| `sponsorSplitPercent` | number | Percentage of inflation rewards going to delegators (0-100) |
| `totalFarmInflation` | string | Total inflation rewards generated by the farm (18 decimals, wei) |
| `totalFarmProtocolDeposit` | string | Total protocol deposit rewards generated by the farm (18 decimals, wei) |
| `delegatorInflationShare` | string | Delegator portion of inflation rewards (18 decimals, wei) |
| `sponsorInflationShare` | string | Farm owner portion of inflation rewards (18 decimals, wei) |
| `delegatorProtocolDepositShare` | string | Protocol deposit going to delegators (always 100%, 18 decimals, wei) |
| `totalDelegatorRewards` | string | Total rewards to delegators (inflation share + PD share, 18 decimals, wei) |

### Miner Farms Breakdown (debug only)

Each miner farm entry includes:

| Field | Type | Description |
|-------|------|-------------|
| `farmId` | string | Farm UUID |
| `farmName` | string \| null | Farm name |
| `sponsorSplitPercent` | number | Percentage of inflation rewards going to miners (0-100) |
| `totalSteps` | number | Total steps/pieces in the mining-center fraction |
| `soldSteps` | number | Number of steps/pieces sold |
| `isPartiallyFilled` | boolean | True if fraction expired with partial sales |
| `totalFarmInflation` | string | Total inflation rewards generated by the farm (18 decimals, wei) |
| `totalFarmProtocolDeposit` | string | Total protocol deposit rewards generated by the farm (18 decimals, wei) |
| `minerInflationShare` | string | Miner portion of inflation rewards (18 decimals, wei) |
| `minerProtocolDepositShare` | string | Protocol deposit going to miners (always 0, 18 decimals, wei) |
| `totalMinerRewards` | string | Total rewards to miners (inflation share only, 18 decimals, wei) |

## How It Works

### 1. Determine Week Range

Uses `getWeekRange()` helper to determine:
- `startWeek`: 97 (first week delegations were enabled)
- `endWeek`: Last completed week based on Thursday 00:00 UTC report schedule

### 2. Get Total Amounts Delegated/Spent

Queries all filled fractions up to the end of the epoch:
- **Launchpad fractions**: Status must be `FILLED`
- **Mining-center fractions**: Status must be `FILLED` OR `EXPIRED` with `splitsSold > 0`
  - For time cutoffs, an expired fraction is treated as “completed” at `expirationAt` (since `filledAt` can be null).

Calculates totals:
- `totalGlwDelegated`: Sum of (stepPrice × splitsSold) for all launchpad fractions
- `totalMiningCenterVolume`: Sum of (stepPrice × splitsSold) for all mining-center fractions

### 3. Fetch Farm Rewards for Last Week

Makes a single batch API call to Control API:
```
POST /farms/rewards-history/batch
{
  "farmIds": [...all unique farm IDs...],
  "startWeek": endWeek,
  "endWeek": endWeek
}
```

Farm IDs are chunked into batches (currently **500 farmIds per request**) to keep payload sizes bounded.

### 4. Calculate Rewards Split

For each farm, rewards are split from a **single inflation pool**:

#### Delegator Farms (Launchpad):
```
Delegator Inflation = totalFarmInflation × (sponsorSplitPercent / 100)
Delegator PD = totalFarmProtocolDeposit × 100%
Total Delegator Rewards = Delegator Inflation + Delegator PD
```

#### Miner Farms (Mining Center):
```
Miner Inflation = totalFarmInflation × (sponsorSplitPercent / 100)
Miner PD = 0

For partially filled (expired):
  Proportional Split = (sponsorSplitPercent × soldSteps) / totalSteps
  Miner Inflation = totalFarmInflation × (Proportional Split / 100)

Total Miner Rewards = Miner Inflation
```

#### Farm Owner:
```
Owner Inflation = totalFarmInflation - Delegator Inflation - Miner Inflation
(Not included in response as we only care about delegators and miners)
```

### 5. Calculate Final Metrics

**GLW per 100 GLW Delegated:**
```
glwPerWeekPer100GlwDelegated = (totalDelegatorRewards × 100 × 10^18) / totalGlwDelegated
```

**GLW per $100 USD Miner:**
```
glwPerWeekPer100UsdMiner = (totalMinerRewards × 100 × 10^6) / totalMiningCenterVolume
```

Note: We multiply by 10^18 and 10^6 respectively to keep results in wei format.

## Important Notes

### Inflation Rewards Distribution

Each farm has **ONE pool of total inflation rewards** that gets divided:
1. Launchpad fraction delegators get their `sponsorSplitPercent`
2. Mining-center fraction miners get their `sponsorSplitPercent`
3. Farm operator gets the leftover (100% - launchpad% - miningCenter%)

**Example:**
```
Farm with 65% launchpad + 6% mining-center:
Total Inflation: 8,476 GLW
├─ Launchpad delegators (65%): 5,510 GLW
├─ Mining-center miners (6%):    509 GLW
└─ Farm operator (29%):        2,458 GLW
```

### Protocol Deposit Distribution

Protocol deposits are **separate from inflation**:
- **Launchpad**: 100% to delegators
- **Mining-center**: 0% to miners (miners get nothing from PD)

### Farms with Both Types

Some farms have both launchpad AND mining-center fractions. These farms:
- Appear in both `delegatorFarms` and `minerFarms` arrays
- Have a single inflation pool divided among both types
- Protocol deposit goes only to delegators

### Partially Filled Mining-Center Fractions

If a mining-center fraction expired before being fully sold:
- `isPartiallyFilled`: true
- Miners receive proportional inflation: `(sponsorSplitPercent × soldSteps / totalSteps)`
- Example: 25% split, 5/10 steps sold → miners get 12.5% of farm inflation

## Use Cases

### 1. Display Current Yields on Marketing Pages
```bash
GET /fractions/yield-per-100
```
Returns simple metrics showing current returns for delegators and miners.

### 2. Analyze Farm-Level Performance
```bash
GET /fractions/yield-per-100?debug=true
```
Returns detailed breakdown of each farm's contribution to overall yields, useful for:
- Identifying high-performing farms
- Understanding reward distribution
- Auditing inflation and protocol deposit splits

### 3. Calculate User Expectations
```javascript
// Example: User wants to delegate 1,000 GLW
const response = await fetch('/fractions/yield-per-100');
const { metrics } = await response.json();
const glwPer100 = Number(metrics.glwPerWeekPer100GlwDelegated) / 1e18;
const weeklyRewards = (1000 * glwPer100) / 100;
console.log(`Expected weekly rewards: ${weeklyRewards.toFixed(2)} GLW`);
```

## Performance

### Optimization Details
- Single batch API call for all farms (not separate calls per type)
- Farm IDs are chunked into batches (currently **500 farmIds per request**) to keep payload sizes bounded.
- Handles farms with both fraction types efficiently
- Typical response time: <2 seconds for 15 farms

### Compared to Wallet-Level Aggregation
- **Old approach**: Fetch rewards for every wallet with splits (~1000+ wallets)
- **New approach**: Fetch rewards for unique farms (~10-20 farms)
- **Performance gain**: ~50-100x faster

## Example Response Values

### Metrics Interpretation

**glwPerWeekPer100GlwDelegated: "5021799038871272148"**
- In wei: 5,021,799,038,871,272,148
- In GLW: 5.02 GLW
- Meaning: For every 100 GLW delegated, earn ~5.02 GLW per week
- Weekly return: ~5.02%
- Annualized: ~262% APY

**glwPerWeekPer100UsdMiner: "13833902856164613616"**
- In wei: 13,833,902,856,164,613,616
- In GLW: 13.83 GLW
- Meaning: For every $100 USD spent on mining equipment, earn ~13.83 GLW per week

### Converting to Human-Readable

All GLW values are returned in wei (18 decimals). To convert:

```javascript
const glwValue = BigInt(metrics.glwPerWeekPer100GlwDelegated);
const humanReadable = Number(glwValue) / 1e18;
console.log(`${humanReadable.toFixed(2)} GLW`);
```

## Error Responses

### 500 - Configuration Error
```json
"CONTROL_API_URL not configured"
```

### 400 - General Error
```json
"Error message here"
```

## Dependencies

### Internal
- `getWeekRange()` - Determines the calculation week range
- `getEpochEndDate()` - Converts week number to timestamp
- `getFilledFractionsUpToEpoch()` - Fetches filled fractions
- `calculateFractionTotals()` - Sums GLW delegated and USDC spent

### External
- Control API: `POST /farms/rewards-history/batch` - Fetches farm rewards

## Calculation Details

### For Delegators (Launchpad)

1. Get all filled launchpad fractions and sum total GLW delegated
2. Map fractions to their farms
3. For each farm with launchpad fractions:
   - Fetch farm's total inflation and protocol deposit rewards for last week
   - Calculate delegator share: `(farmInflation × sponsorSplitPercent / 100) + farmProtocolDeposit`
4. Sum delegator rewards across all farms
5. Calculate metric: `(totalDelegatorRewards × 100 × 10^18) / totalGlwDelegated`

### For Miners (Mining Center)

1. Get all filled/expired mining-center fractions and sum total USDC spent
2. Map fractions to their farms
3. For each farm with mining-center fractions:
   - Fetch farm's total inflation rewards for last week
   - If fully filled: `minerShare = farmInflation × sponsorSplitPercent / 100`
   - If partially filled: `minerShare = farmInflation × (sponsorSplitPercent × soldSteps / totalSteps) / 100`
   - Protocol deposit share: always 0
4. Sum miner rewards across all farms
5. Calculate metric: `(totalMinerRewards × 100 × 10^6) / totalUsdcSpent`

Note: We multiply by 10^6 instead of 10^18 because USDC has 6 decimals while GLW has 18.

## Important Concepts

### Sponsor Split Percent

The `sponsorSplitPercent` determines what percentage of a farm's **inflation rewards** goes to fraction purchasers (delegators or miners):
- **NOT** a split between delegators and miners
- **IS** a split from the farm's total inflation pool
- Remaining inflation goes to the farm owner/operator

### Single Inflation Pool

Each farm has ONE inflation pool that is divided among:
1. Launchpad delegators (get their %)
2. Mining-center miners (get their %)
3. Farm operator (gets the leftover)

Example farm with both types:
```
Farm Inflation: 10,000 GLW
├─ Launchpad (65%): 6,500 GLW → Delegators
├─ Mining-center (6%): 600 GLW → Miners
└─ Farm operator (29%): 2,900 GLW → Owner
```

### Protocol Deposit vs Inflation

**Protocol Deposit Rewards:**
- 100% to launchpad delegators
- 0% to mining-center miners
- Generated when farms pay their protocol deposits

**Inflation Rewards:**
- Split based on `sponsorSplitPercent` for each fraction type
- Comes from GLW token inflation schedule

## Historical Context

### Why Week 97?

Week 97 was the first week that delegations (launchpad fractions) were enabled in the protocol. Prior weeks are excluded from the calculation.

### Week Range Logic

The `endWeek` is calculated based on:
- Weekly reports generate every Thursday at 00:00 UTC
- The last completed week is the week for which a report has been generated
- Uses `getLastCompletedWeekForReports()` to determine this dynamically

## Example Use Case

### Calculate User's Expected Returns

```typescript
// User wants to delegate 10,000 GLW
const response = await fetch('/fractions/yield-per-100');
const data = await response.json();

const glwPer100 = Number(data.metrics.glwPerWeekPer100GlwDelegated) / 1e18;
const userAmount = 10000;

const weeklyRewards = (userAmount * glwPer100) / 100;
const monthlyRewards = weeklyRewards * 4.33;
const annualRewards = weeklyRewards * 52.18;
const apy = (annualRewards / userAmount) * 100;

console.log(`Weekly: ${weeklyRewards.toFixed(2)} GLW`);
console.log(`Monthly: ${monthlyRewards.toFixed(2)} GLW`);
console.log(`Annual: ${annualRewards.toFixed(2)} GLW`);
console.log(`APY: ${apy.toFixed(2)}%`);
```

Output:
```
Weekly: 502.18 GLW
Monthly: 2174.44 GLW
Annual: 26213.81 GLW
APY: 262.14%
```

## Performance Characteristics

- **Typical execution time**: 1-2 seconds
- **Database queries**: 2-3 queries
- **External API calls**: 1 batch call (for up to 500 farms)
- **Scales well**: O(farms) not O(wallets)

## Related Endpoints

- `GET /fractions/summary` - High-level fraction sales totals
- `GET /fractions/average-apy` - Average APY across all wallets (more granular)
- `GET /fractions/rewards-breakdown` - Detailed wallet/farm rewards breakdown
- `GET /fractions/farms-per-piece-stats` - Per-piece stats for all farms

